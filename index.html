<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
	<title>Transitions demo</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<!-- <link href='http://fonts.googleapis.com/css?family=Coustard' rel='stylesheet' type='text/css'> -->
	<style type="text/css">
		*  { margin: 0; padding: 0;}
		html {
			background-color: #000;
		}
		body {
			/*font-family: 'Coustard', serif;*/
		}
		#page-wrap {
			width: 720px;
			margin: 0 auto;
			background-color: #ddd;
			border: 2px solid #999;
			padding: 20px;
			margin-top: 80px;
		}
		#slideshow {
			width: 500px;
			height: 250px;
			margin: 80px auto;
			border: 1px solid #aaa;
			background-color: #444
		}
		a {
			color: #ffa500;
			text-decoration: none;
		}
		a:hover {
			text-decoration: underline;
		}
		a:visited {
			color: #d67600;
		}
		a:active{
			color: #ffff00;
		}
		button {
			padding: 5px;
		}
		/*
		button.transition {
			background-color: #000;
			color: orange;
			font-weight: bold;
			font-family: monospace;
			border-radius: 5px;
		}
		*/
	</style>
</head>
<body>
	<div id="page-wrap">
		<div id="slideshow"></div>

		<div id="gui">
			<fieldset id="sliding-door">
				<legend>sliding door</legend>
				<button>left</button>
				<button>right</button>
				<button>top</button>
				<button>bottom</button>
			</fieldset>
			
			<fieldset id="sliding-doors">
				<legend>sliding doors</legend>
				<button>horizontal</button>
				<button>vertical</button>
			</fieldset>
		</div>
	</div>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
	<script>!window.jQuery && document.write('<script src="http://code.jquery.com/jquery-1.6.2.min.js"><\/script>');</script>
	<script src="jquery.easing.1.3.js"></script>
	<script>
		var
			slideshow = $('#slideshow'),
			buff = [new Image(), new Image()],
			visibleBuff,
			images = [
				'fractal-e2.jpg',
				'fractal-e9.jpg'
			],
			backIndex = 1,
			frontIndex = 2,
			//transBtns = $('#sliding-door button'),
			frameWidth, frameHeight,
			guiElems = $('#gui button')
		;
		
		preloadImages();
		
		$('#gui').delegate('button', 'click', function(e) {
			guiElems.attr('disabled', 'disabled');
			e.stopPropagation();
		});
		
		$('#sliding-door').delegate('button', 'click', function(e) {
			slidingDoor($(this).text());
		});
		
		$('#sliding-doors').delegate('button', 'click', function(e) {
			slidingDoors($(this).text());
		});
		
		slideshow.bind('afterTransition', function() {
			//transBtns.attr('disabled', '');
			guiElems.removeAttr('disabled');
		});
		
		// Functions
		
		function preloadImages() {
			var
				numImages = images.length,
				count = numImages,
				i
			;
			for (i = 0; i < numImages; ++i) {
				img = new Image();
				img.onload = function() {
					if (--count === 0)
						initSlideshow();
				};
				img.src = images[i];
			}
		}
		
		function initSlideshow() {
			slideshow.css({
				position: 'relative',
				overflow: 'hidden'
			});
			
			frameWidth = slideshow.width();
			frameHeight = slideshow.height();
			
			$(buff[0])
				.css({
					position: 'absolute',
					left: 0,
					top: 0,
					zIndex: backIndex
				})
				.attr('src', images[0])
				//.width(frameWidth)
				//.height(frameHeight)
			;
			
			$(buff[1])
				.css({
					position: 'absolute',
					left: 0,
					top: 0,
					zIndex: frontIndex
				})
				.attr('src', images[1])
				//.width(frameWidth)
				//.height(frameHeight)
			;
			
			slideshow.append(buff[0], buff[1]);
			
			visibleBuff = 1;
		}
		
		function slidingDoor(dir) {
			var
				front = $(buff[visibleBuff]),
				back = $(buff[1-visibleBuff]),
				duration = 3000,
				prop = {},
				axis,
				sgn,
				offset
			;
			switch (dir) {
				case 'top':
					axis = 'top';
					sgn = -1;
					offset = frameHeight;
					break;
				case 'right':
					axis = 'left';
					sgn = 1;
					offset = frameWidth;
					break;
				case 'bottom':
					axis = 'top';
					sgn = 1;
					offset = frameHeight;
					break;
				case 'left':
					axis = 'left';
					sgn = -1;
					offset = frameWidth;
					break;
			}
			
			prop[axis] = sgn * offset + 'px';
			
			front.animate(
				prop,
				duration,
				'easeOutQuad',
				afterTransition
			); // 100% works?
		}
		
		function slidingDoors(axis) {
			var
				front = $(buff[visibleBuff]),
				back = $(buff[1-visibleBuff]),
				duration = 3000,
				leftDoor = $('<div class="left-door"></div>'),
				rightDoor = $('<div class="right-door"></div>'),
				doorWidth = frameWidth / 2,
				zIndex = front.css('zIndex')
			;

			// Seup doors
			leftDoor.css({
				position: 'absolute',
				width: doorWidth + 'px',
				height: frameHeight,
				left: 0,
				top: 0,
				backgroundImage: 'url(' + front.attr('src') + ')',
				backgroundPosition: 'left top',
				zIndex: zIndex
			});
			rightDoor.css({
				position: 'absolute',
				width: doorWidth + 'px',
				height: frameHeight,
				right: 0,
				top: 0,
				backgroundImage: 'url(' + front.attr('src') + ')',
				backgroundPosition: 'right top',
				zIndex: zIndex
			});
			
			slideshow.append(leftDoor, rightDoor);
			front.hide();
			
			$.when(
				leftDoor.animate(
					{left: -doorWidth + 'px'},
					duration,
					'easeOutQuad'
				),
				rightDoor.animate(
					{right: -doorWidth + 'px'},
					duration,
					'easeOutQuad'
				)
			).then(function() {
				leftDoor.remove();
				rightDoor.remove();
				afterTransition();
			});
		}
		
		// Called by every transition to set the stage for the next one
		function afterTransition() {
			// Adjust the new front buffer
			$(buff[1-visibleBuff]).css({zIndex: frontIndex});
			
			// Adjust the new back buffer
			$(buff[visibleBuff])
				.css({
					zIndex: backIndex
				})
				.css({
					left: 0,
					top: 0
				})
				.show()
			;
			
			visibleBuff = 1 - visibleBuff;
			
			slideshow.trigger('afterTransition');
		}
	</script>
</body>
</html>